# ä¸­é—´ä»¶å®æˆ˜

> åŸºäºä½ çš„é¡¹ç›®ç»éªŒï¼ˆRedisã€RabbitMQã€Dockerï¼‰æ•´ç†çš„ä¸­é—´ä»¶çŸ¥è¯†

---

## ğŸ“š å­¦ä¹ ç›®æ ‡

- æŒæ¡Redisæ•°æ®ç»“æ„ä¸ç¼“å­˜ç­–ç•¥
- ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©
- æŒæ¡åˆ†å¸ƒå¼é”å®ç°
- ç†Ÿç»ƒä½¿ç”¨RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
- ç†è§£æ¶ˆæ¯å¯é æ€§ä¿è¯
- æŒæ¡Dockerå®¹å™¨åŒ–éƒ¨ç½²

---

## 1. RedisåŸºç¡€

### 1.1 æ•°æ®ç»“æ„

| æ•°æ®ç»“æ„ | å‘½ä»¤ | åº”ç”¨åœºæ™¯ |
|----------|------|----------|
| String | SET, GET, INCR, DECR | ç¼“å­˜ã€è®¡æ•°å™¨ |
| Hash | HSET, HGET, HMGET | å¯¹è±¡ç¼“å­˜ |
| List | LPUSH, RPUSH, LPOP, RPOP | é˜Ÿåˆ—ã€æ ˆ |
| Set | SADD, SREM, SMEMBERS | å»é‡ã€äº¤é›† |
| ZSet | ZADD, ZRANGE, ZRANK | æ’è¡Œæ¦œ |
| Bitmap | SETBIT, GETBIT | ç­¾åˆ°ã€çŠ¶æ€ |

### 1.2 Stringåº”ç”¨

**ç¼“å­˜**

```java
@Autowired
private RedisTemplate<String, User> redisTemplate;

public User getUser(Long id) {
    String key = "user:" + id;
    User user = redisTemplate.opsForValue().get(key);
    
    if (user == null) {
        user = userMapper.selectById(id);
        redisTemplate.opsForValue().set(key, user, 3600, TimeUnit.SECONDS);
    }
    
    return user;
}
```

**åˆ†å¸ƒå¼è®¡æ•°å™¨**

```java
@Autowired
private StringRedisTemplate redisTemplate;

public long increment(String key) {
    return redisTemplate.opsForValue().increment(key);
}

public long incrementWithExpire(String key, long expire) {
    Long count = redisTemplate.opsForValue().increment(key);
    if (count == 1) {
        redisTemplate.expire(key, expire, TimeUnit.SECONDS);
    }
    return count;
}
```

### 1.3 Hashåº”ç”¨

**å¯¹è±¡ç¼“å­˜**

```java
public void cacheDevice(Device device) {
    String key = "device:" + device.getId();
    Map<String, Object> map = new HashMap<>();
    map.put("name", device.getName());
    map.put("status", device.getStatus());
    map.put("userId", device.getUserId());
    redisTemplate.opsForHash().putAll(key, map);
    redisTemplate.expire(key, 3600, TimeUnit.SECONDS);
}

public Device getDevice(Long id) {
    String key = "device:" + id;
    Map<Object, Object> map = redisTemplate.opsForHash().entries(key);
    
    if (map.isEmpty()) {
        return null;
    }
    
    Device device = new Device();
    device.setId(id);
    device.setName((String) map.get("name"));
    device.setStatus((String) map.get("status"));
    device.setUserId((Long) map.get("userId"));
    return device;
}
```

### 1.4 Liståº”ç”¨

**é˜Ÿåˆ—**

```java
public void TaskQueue {
    
    public void pushTask(String task) {
        redisTemplate.opsForList().rightPush("task:queue", task);
    }
    
    public String popTask() {
        return redisTemplate.opsForList().leftPop("task:queue");
    }
}
```

### 1.5 ZSetåº”ç”¨

**æ’è¡Œæ¦œ**

```java
public void addRank(String userId, int score) {
    redisTemplate.opsForZSet().add("rank:leaderboard", userId, score);
}

public Set<String> getTopRank(int limit) {
    return redisTemplate.opsForZSet().reverseRange("rank:leaderboard", 0, limit - 1);
}

public long getRank(String userId) {
    Long rank = redisTemplate.opsForZSet().reverseRank("rank:leaderboard", userId);
    return rank != null ? rank + 1 : 0;
}
```

---

## 2. Redisç¼“å­˜ç­–ç•¥

### 2.1 ç¼“å­˜ç©¿é€

**é—®é¢˜**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¯·æ±‚ç©¿é€åˆ°æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ1ï¼šç¼“å­˜ç©ºå€¼**

```java
public User getUser(Long id) {
    String key = "user:" + id;
    User user = redisTemplate.opsForValue().get(key);
    
    if (user != null) {
        if (user.isNull()) {
            return null;
        }
        return user;
    }
    
    user = userMapper.selectById(id);
    if (user == null) {
        user = User.nullUser();
    }
    
    redisTemplate.opsForValue().set(key, user, 300, TimeUnit.SECONDS);
    return user.isNull() ? null : user;
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šå¸ƒéš†è¿‡æ»¤å™¨**

```java
@Service
public class UserService {
    
    @Autowired
    private BloomFilter<Long> bloomFilter;
    
    public User getUser(Long id) {
        if (!bloomFilter.mightContain(id)) {
            return null;
        }
        
        User user = redisTemplate.opsForValue().get("user:" + id);
        if (user == null) {
            user = userMapper.selectById(id);
            if (user != null) {
                redisTemplate.opsForValue().set("user:" + id, user, 3600, TimeUnit.SECONDS);
            }
        }
        return user;
    }
}
```

### 2.2 ç¼“å­˜å‡»ç©¿

**é—®é¢˜**ï¼šçƒ­ç‚¹keyè¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶å‡»ç©¿åˆ°æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆï¼šäº’æ–¥é”**

```java
public User getUser() {
    String key = "user:" + id;
    String lockKey = "lock:user:" + id;
    
    User user = redisTemplate.opsForValue().get(key);
    if (user != null) {
        return user;
    }
    
    Boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
    if (locked) {
        try {
            user = userMapper.selectById(id);
            redisTemplate.opsForValue().set(key, user, 3600, TimeUnit.SECONDS);
        } finally {
            redisTemplate.delete(lockKey);
        }
    } else {
        Thread.sleep(100);
        user = redisTemplate.opsForValue().get(key);
        if (user == null) {
            user = getUser(id);
        }
    }
    
    return user;
}
```

### 2.3 ç¼“å­˜é›ªå´©

**é—®é¢˜**ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸï¼Œè¯·æ±‚å…¨éƒ¨æ‰“åˆ°æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ1ï¼šéšæœºè¿‡æœŸæ—¶é—´**

```java
public void cacheDevice(Device device) {
    long randomExpire = 3600 + RandomUtils.nextLong(0, 600);
    redisTemplate.opsForValue().set("device:" + device.getId(), device, randomExpire, TimeUnit.SECONDS);
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šäº’æ–¥é” + é‡è¯•**

```java
public Device getDevice(Long id) {
    String key = "device:" + id;
    String lockKey = "lock:device:" + id;
    
    Device device = redisTemplate.opsForValue().get(key);
    if (device != null) {
        return device;
    }
    
    int retry = 0;
    while (retry < 3) {
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", 5, TimeUnit.SECONDS);
        if (locked) {
            try {
                device = deviceMapper.selectById(id);
                redisTemplate.opsForValue().set(key, device, 3600, TimeUnit.SECONDS);
                return device;
            } finally {
                redisTemplate.delete(lockKey);
            }
        } else {
            retry++;
            Thread.sleep(100);
        }
    }
    
    return device;
}
```

---

## 3. åˆ†å¸ƒå¼é”

### 3.1 Redisåˆ†å¸ƒå¼é”

```java
public class RedisLock {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String UNLOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "    return redis.call('del', KEYS[1]) " +
        "else " +
        "    return 0 " +
        "end";
    
    public boolean lock(String key, String value, long expire) {
        return redisTemplate.opsForValue().setIfAbsent(key, value, expire, TimeUnit.SECONDS);
    }
    
    public boolean unlock(String key, String value) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>(UNLOCK_SCRIPT, Long.class);
        Long result = redisTemplate.execute(script, Collections.singletonList(key), value);
        return result != null && result == 1;
    }
    
    public boolean tryLock(String key, String value, long expire, long timeout) {
        long start = System.currentTimeMillis();
        while (true) {
            if (lock(key, value, expire)) {
                return true;
            }
            long elapsed = System.currentTimeMillis() - start;
            if (elapsed > timeout) {
                return false;
            }
            Thread.sleep(100);
        }
    }
}
```

---

## 4. RabbitMQ

### 4.1 æ ¸å¿ƒæ¦‚å¿µ

- Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…
- Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…
- Exchangeï¼šäº¤æ¢æœº
- Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—
- Bindingï¼šç»‘å®šå…³ç³»
- Routing Keyï¼šè·¯ç”±é”®

### 4.2 äº¤æ¢æœºç±»å‹

| äº¤æ¢æœºç±»å‹ | è·¯ç”±æ–¹å¼ |
|-----------|---------|
| Direct | ç²¾ç¡®åŒ¹é…Routing Key |
| Fanout | å¹¿æ’­åˆ°æ‰€æœ‰é˜Ÿåˆ— |
| Topic | æ¨¡ç³ŠåŒ¹é…Routing Key |
| Headers | åŒ¹é…headers |

### 4.3 åŸºç¡€ä½¿ç”¨

**ç”Ÿäº§è€…**

```java
@Service
public class ApprovalProducer {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendApproval(ApprovalMessage message) {
        rabbitTemplate.convertAndSend(
            "approval.exchange",
            "approval.routing",
            message
        );
    }
}
```

**æ¶ˆè´¹è€…**

```java
@RabbitListener(queues = "approval.queue")
public void receiveApproval(ApprovalMessage message) {
    try {
        processApproval(message);
    } catch (Exception e) {
        log.error("å¤„ç†å®¡æ‰¹æ¶ˆæ¯å¤±è´¥", e);
        throw e;
    }
}
```

---

## 5. Docker

### 5.1 Dockerfile

```dockerfile
FROM openjdk:17-jdk-alpine

WORKDIR /app

COPY target/app.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 5.2 Docker Compose

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: erp
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: 123456
    ports:
      - "5672:5672"
      - "15672:15672"

  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
      - rabbitmq
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/erp
      SPRING_REDIS_HOST: redis
      SPRING_RABBITMQ_HOST: rabbitmq

volumes:
  mysql-data:
  redis-data:
```

---

## é¢è¯•é«˜é¢‘é¢˜

### åŸºç¡€é¢˜

1. Redisæœ‰å“ªäº›æ•°æ®ç»“æ„ï¼Ÿ
2. RedisæŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿ
3. Rediså’ŒMemcachedçš„åŒºåˆ«ï¼Ÿ
4. ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ï¼Ÿ
5. å¦‚ä½•å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ
6. RabbitMQçš„äº¤æ¢æœºç±»å‹æœ‰å“ªäº›ï¼Ÿ
7. Dockerçš„æ ¸å¿ƒæ¦‚å¿µï¼Ÿ

### ä¸­ç­‰é¢˜

1. å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€ï¼Ÿ
2. å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿ï¼Ÿ
3. å¦‚ä½•è§£å†³ç¼“å­˜é›ªå´©ï¼Ÿ
4. Redisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç°ï¼Ÿ
5. å¦‚ä½•ä¿è¯æ¶ˆæ¯å¹‚ç­‰æ€§ï¼Ÿ
6. RabbitMQå¦‚ä½•å®ç°æ¶ˆæ¯ç¡®è®¤ï¼Ÿ
7. Docker Composeçš„ä½œç”¨ï¼Ÿ

---

## å­¦ä¹ å»ºè®®

1. **é‡ç‚¹æŒæ¡**ï¼šRedisç¼“å­˜ç­–ç•¥ã€åˆ†å¸ƒå¼é”ã€RabbitMQã€Docker
2. **ç†è§£åŸç†**ï¼šRedisæ•°æ®ç»“æ„ã€RabbitMQäº¤æ¢æœº
3. **å®è·µåº”ç”¨**ï¼šé¡¹ç›®ä¸­çš„ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å®¹å™¨åŒ–éƒ¨ç½²

**å‚è€ƒæ–‡æ¡£**ï¼š
- Rediså®˜æ–¹æ–‡æ¡£
- RabbitMQå®˜æ–¹æ–‡æ¡£
- Dockerå®˜æ–¹æ–‡æ¡£

---

**æ›´æ–°è¿›åº¦åˆ°å­¦ä¹ è¿›åº¦.md**