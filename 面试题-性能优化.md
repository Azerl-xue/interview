# 面试题 - 性能优化

> 性能优化类面试题

---

## 1. 系统优化思路

### Q1: 系统慢了你会怎么排查？

**参考回答**：

1. **监控指标**
   - 查看CPU、内存、磁盘IO
   - 查看数据库慢连接
   - 查看缓存命中率

2. **日志分析**
   - 分析应用日志
   - 查看错误堆栈
   - 统计慢接口

3. **性能工具**
   - Arthas分析代码
   - JProfiler分析内存
   - JVisualVM监控

4. **逐步优化**
   - 识别瓶颈
   - 逐个优化
   - 验证效果

**实际案例**：
在ERP系统出现响应慢的问题时，我先查看了监控指标，发现数据库连接池满了，然后分析日志发现是查询慢，最后通过Explain分析SQL，添加索引解决了问题。

---

### Q2: 如何做性能测试？

**参考回答**：

1. **测试工具**
   - JMeter
   - LoadRunner
   - Gatling

2. **测试场景**
   - 正常负载测试
   - 峰值负载测试
   - 持续压力测试

3. **监控指标**
   - TPS/ QPS
   - 响应时间
   - 错误率
   - 资源使用率

**实际案例**：
在智能合同项目上线前，我使用JMeter进行了压测，模拟500并发用户，测试了合同创建、审批、查询等接口，发现合同查询接口响应时间过长，通过添加Redis缓存优化到了500ms以内。

---

## 2. 数据库调优

### Q3: 如何优化慢SQL？

**参考回答**：

1. **分析执行计划**
   - 使用EXPLAIN
   - 查看type、rows、Extra
   - 识别全表扫描

2. **添加索引**
   - 为WHERE条件添加索引
   - 为JOIN字段添加索引
   - 为ORDER BY添加索引

3. **优化SQL**
   - 避免SELECT *
   - 避免子查询
   - 使用LIMIT

**实际案例**：
在ERP系统中，设备查询SQL type为ALL，扫描10000+行。我通过Explain分析，发现user_id和status字段没有索引，添加联合索引后，type变为ref，扫描行数降到10。

---

### Q4: 索引是如何优化的？

**参考回答**：

1. **选择合适的字段**
   - 选择性高的字段
   - 频繁查询的字段
   - 经常JOIN的字段

2. **联合索引顺序**
   - 遵循最左前缀原则
   - 高选择性字段在前
   - 范围查询字段在后

3. **索引类型**
   - 普通索引
   - 唯一索引
   - 联合索引
   - 覆盖索引

**实际案例**：
在合同查询中，经常按status和create_time查询，我创建了联合索引idx_status_time(status, create_time)，查询使用索引，性能大幅提升。

---

### Q5: 如何优化数据库连接池？

**参考回答**：

1. **核心参数**
   - initialSize：初始连接数
   - minIdle：最小空闲连接
   - maxActive：最大活动连接
   - maxWait：获取连接最大等待时间

2. **配置原则**
   - 初始连接数=CPU核心数
   - 最大连接数=CPU核心数*2+1
   - 等待时间根据业务设置

3. **监控调优**
   - 监控活跃连接数
   - 监控等待连接数
   - 根据监控调整参数

**实际案例**：
在ERP系统中，我将连接池配置为：initialSize=5, minIdle=5, maxActive=20, maxWait=60000，并通过监控发现峰值时连接数达到15，配置合理。

---

## 3. 缓存设计

### Q6: 如何设计缓存策略？

**参考回答**：

1. **缓存类型**
   - 本地缓存：Caffeine、Guava
   - 分布式缓存：Redis、Memcached

2. **缓存模式**
   - Cache-Aside：主动加载
   - Read-Through：自动加载
   - Write-Through：同步写入
   - Write-Behind：异步写入

3. **缓存更新**
   - 更新数据库后删除缓存
   - 使用过期时间
   - 版本号控制

**实际案例**：
在ERP系统中，我使用Redis作为缓存，采用Cache-Aside模式。更新设备时，先更新数据库，然后删除Redis缓存，下次查询时重新加载。

---

### Q7: 如何解决缓存穿透、击穿、雪崩？

**参考回答**：

**缓存穿透**：
- 缓存空值
- 布隆过滤器

**缓存击穿**：
- 互斥锁
- 热点数据永不过期

**缓存雪崩**：
- 随机过期时间
- 互斥锁
- 熔断降级

**实际案例**：
在ERP系统中，我使用了三种策略：
1. 缓存空值防止穿透
2. 互斥锁防止击穿
3. 随机过期时间防止雪崩

---

### Q8: 缓存与数据库一致性如何保证？

**参考回答**：

1. **强一致性**
   - 更新数据库+缓存在同一事务
   - 性能较差

2. **最终一致性**
   - 更新数据库后删除缓存
   - 延迟双删
   - 消息队列异步更新

3. **读写分离**
   - 写操作：更新数据库+删除缓存
   - 读操作：先读缓存，无则读数据库

**实际案例**：
在ERP系统中，我采用先更新数据库、再删除缓存的策略，保证最终一致性。对于关键数据，使用延迟双删确保缓存删除成功。

---

## 4. 并发处理

### Q9: 如何处理高并发？

**参考回答**：

1. **垂直扩展**
   - 增加服务器配置
   - 提升CPU、内存

2. **水平扩展**
   - 负载均衡
   - 集群部署

3. **异步处理**
   - 消息队列
   - 异步接口
   - 线程池

4. **限流降级**
   - 限流算法
   - 服务降级
   - 熔断

**实际案例**：
在ERP系统的审批流程中，我使用RabbitMQ异步处理审批请求，提升系统吞吐量。同时使用Redis实现限流，防止高并发冲垮系统。

---

### Q10: 线程池如何配置？

**参考回答**：

1. **核心参数**
   - corePoolSize：核心线程数
   - maximumPoolSize：最大线程数
   - keepAliveTime：线程空闲存活时间
   - workQueue：任务队列
   - handler：拒绝策略

2. **配置原则**
   - CPU密集型：核心数+1
   - IO密集型：核心数*2

3. **拒绝策略**
   - AbortPolicy：抛出异常
   - CallerRunsPolicy：调用者执行
   - DiscardPolicy：丢弃
   - DiscardOldestPolicy：丢弃最老

**实际案例**：
在文档处理项目中，我配置了线程池：corePoolSize=4, maximumPoolSize=10, workQueue=LinkedBlockingQueue(100)，使用CallerRunsPolicy拒绝策略，确保任务不丢失。

---

## 5. JVM调优

### Q11: JVM参数如何调优？

**参考回答**：

1. **内存参数**
   - -Xms：初始堆内存
   - -Xmx：最大堆内存
   - -Xmn：新生代大小
   - -XX:MetaspaceSize：元空间初始大小

2. **GC参数**
   - -XX:+UseG1GC：使用G1收集器
   - -XX:MaxGCPauseMillis：最大GC停顿时间
   - -XX:G1HeapRegionSize：G1Region大小

3. **日志参数**
   - -Xloggc：GC日志
   - -XX:+PrintGCDetails：打印GC详情

**实际案例**：
在智能合同项目中，我配置了JVM参数：
```
-Xms2g -Xmx2g -Xmn512m 
-XX:+UseG1GC 
-XX:MaxGCPauseMillis=200 
-Xloggc:gc.log
```

---

### Q12: 如何排查OOM？

**参考回答**：

1. **分析堆转储**
   - jmap生成堆转储文件
   - 使用MAT分析
   - 找到大对象

2. **分析GC日志**
   - 查看GC频率和时间
   - 识别内存泄漏
   - 优化对象创建

3. **代码分析**
   - 检查静态集合
   - 检查未关闭资源
   - 检查ThreadLocal

**实际案例**：
在某次OOM后，我使用jmap导出堆转储，用MAT分析发现是静态ArrayList未清理导致内存泄漏，修复后问题解决。

---

## 🔥 补充问题

1. 如何优化批量插入？
2. 如何优化大批量数据查询？
3. 如何优化前端页面性能？
4. 如何做全链路性能监控？
5. 如何设计限流算法？

---

**建议结合ERP系统中的性能优化案例来回答这些问题。**