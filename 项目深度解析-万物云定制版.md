# é¡¹ç›®æ·±åº¦è§£æ - ä¸‡ç‰©äº‘å®šåˆ¶ç‰ˆ

> å¤šç³»ç»Ÿé›†æˆåˆåŒç®¡ç†ç³»ç»Ÿ

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**ï¼šæ™ºèƒ½åˆåŒä¸‡ç‰©äº‘å®šåˆ¶ç‰ˆ  
**é¡¹ç›®è§’è‰²**ï¼šåç«¯ç ”å‘å·¥ç¨‹å¸ˆï¼ˆä¸»å¯¼ï¼‰  
**å¼€å‘æ—¶é—´**ï¼š2025.01 - è‡³ä»Š  
**æŠ€æœ¯æ ˆ**ï¼šJava 17ã€Spring Bootã€MyBatisã€MySQLã€Redisã€Dockerã€Maven  

---

## ğŸ¯ é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

### èƒŒæ™¯

ä¸‡ç‰©äº‘å®¢æˆ·åˆåŒç®¡ç†åˆ†æ•£ï¼Œå¤šä¸ªç³»ç»Ÿï¼ˆé¢„ç®—ã€é‡‡è´­ï¼‰ç‹¬ç«‹è¿è¡Œï¼Œå¯¼è‡´ï¼š
- åˆåŒä¸é¢„ç®—ã€é‡‡è´­æ•°æ®ä¸å…³è”
- åˆåŒæ‰§è¡Œè·Ÿè¸ªå›°éš¾
- æ•°æ®å½•å…¥é‡å¤

### ç›®æ ‡

- ä¸å®¢æˆ·ç°æœ‰æ ¸å¿ƒç³»ç»Ÿæ·±åº¦é›†æˆ
- å®ç°æ•°æ®å®æ—¶åŒæ­¥
- ä¸šåŠ¡æµç¨‹è‡ªåŠ¨åŒ–
- ç»Ÿä¸€åˆåŒç®¡ç†

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸‡ç‰©äº‘ä¸šåŠ¡ç³»ç»Ÿ                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ é¢„ç®—ç³»ç»Ÿ  â”‚  â”‚ é‡‡è´­ç³»ç»Ÿ  â”‚  â”‚ é¡¹ç›®ç®¡ç† â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘           â†‘           â†‘
         â”‚           â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ æ•°æ®åŒæ­¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ™ºèƒ½åˆåŒå®šåˆ¶ç³»ç»Ÿï¼ˆæ¥å£å±‚ï¼‰            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ•°æ®åŒæ­¥æœåŠ¡                       â”‚   â”‚
â”‚  â”‚ å¯¹æ¥é€‚é…å™¨                         â”‚   â”‚
â”‚  â”‚ æ•°æ®æ˜ å°„å™¨                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ™ºèƒ½åˆåŒæ ¸å¿ƒç³»ç»Ÿ                  â”‚
â”‚  åˆåŒç®¡ç† | å®¡æ‰¹æµç¨‹ | å½’æ¡£ç®¡ç†         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“           â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  MySQL  â”‚  â”‚  Redis  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ•°æ®å¯¹æ¥æ ‡å‡†è®¾è®¡

#### æ¥å£è§„èŒƒ

```java
public interface DataSyncAdapter<T> {
    DataSyncResult syncData(T data);
    T queryData(String businessId);
}
```

#### å¯¹æ¥é€‚é…å™¨

```java
@Component
public class BudgetSystemAdapter implements DataSyncAdapter<BudgetData> {
    
    @Autowired
    private BudgetApiClient budgetClient;
    
    @Override
    public DataSyncResult syncData(BudgetData data) {
        SyncRequest request = new SyncRequest();
        request.setBudgetId(data.getBudgetId());
        request.setAmount(data.getAmount());
        request.setProjectCode(data.getProjectCode());
        
        SyncResponse response = budgetClient.syncBudget(request);
        
        DataSyncResult result = new DataSyncResult();
        result.setSuccess(response.isSuccess());
        result.setMessage(response.getMessage());
        result.setBusinessId(data.getBudgetId());
        return result;
    }
    
    @Override
    public BudgetData queryData(String businessId) {
        return budgetClient.queryBudget(businessId);
    }
}

@Component
public class PurchaseSystemAdapter implements DataSyncAdapter<PurchaseData> {
    
    @Autowired
    private PurchaseApiClient purchaseClient;
    
    @Override
    public DataSyncResult syncData(PurchaseData data) {
    }
    
    @Override
    public PurchaseData queryData(String businessId) {
        return purchaseClient.queryPurchase(businessId);
    }
}
```

### 2. æ•°æ®å®æ—¶åŒæ­¥

#### åŒæ­¥æœåŠ¡

```java
@Service
public class ContractSyncService {
    
    @Autowired
    private Map<String, DataSyncAdapter> adapterMap;
    
    @Autowired
    private ContractMapper contractMapper;
    
    @Autowired
    private SyncRecordMapper syncRecordMapper;
    
    @Transactional(rollbackFor = Exception.class)
    public void syncToBudget(Contract contract) {
        DataSyncAdapter adapter = adapterMap.get("BUDGET");
        
        BudgetData budgetData = convertToBudgetData(contract);
        DataSyncResult result = adapter.syncData(budgetData);
        
        if (result.isSuccess()) {
            updateContractSyncStatus(contract.getId(), "BUDGET", "SYNCED");
        } else {
            updateContractSyncStatus(contract.getId(), "BUDGET", "FAILED");
        }
        
        saveSyncRecord(contract.getId(), "BUDGET", result);
    }
    
    @Transactional(rollbackFor = Exception.class)
    public void syncToPurchase(Contract contract) {
        DataSyncAdapter adapter = adapterMap.get("PURCHASE");
        
        PurchaseData purchaseData = convertToPurchaseData(contract);
        DataSyncResult result = adapter.syncData(purchaseData);
        
        if (result.isSuccess()) {
            updateContractSyncStatus(contract.getId(), "PURCHASE", "SYNCED");
        } else {
            updateContractSyncStatus(contract.getId(), "PURCHASE", "FAILED");
        }
        
        saveSyncRecord(contract.getId(), "PURCHASE", result);
    }
}
```

#### å®šæ—¶åŒæ­¥

```java
@Component
public class SyncScheduleService {
    
    @Autowired
    private ContractSyncService syncService;
    
    @Autowired
    private ContractMapper contractMapper;
    
    @Scheduled(cron = "0 0/5 * * * ?")
    public void autoSync() {
        List<Contract> contracts = contractMapper.selectPendingSync();
        
        for (Contract contract : contracts) {
            try {
                syncService.syncToBudget(contract);
                syncService.syncToPurchase(contract);
            } catch (Exception e) {
                log.error("åŒæ­¥å¤±è´¥: " + contract.getId(), e);
            }
        }
    }
}
```

### 3. æ•°æ®ä¸€è‡´æ€§ä¿è¯

#### æœ¬åœ°æ¶ˆæ¯è¡¨

```sql
CREATE TABLE `sync_message` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `message_id` VARCHAR(50) NOT NULL,
  `business_type` VARCHAR(20) NOT NULL,
  `business_id` BIGINT NOT NULL,
  `sync_type` VARCHAR(20) NOT NULL,
  `status` VARCHAR(20) DEFAULT 'PENDING',
  `retry_count` INT DEFAULT 0,
  `error_message` TEXT,
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_message_id` (`message_id`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### æ¶ˆæ¯å¤„ç†

```java
@Service
public class SyncMessageService {
    
    @Autowired
    private SyncMessageMapper syncMessageMapper;
    
    @Autowired
    private ContractSyncService syncService;
    
    @Scheduled(fixedDelay = 1000)
    public void processMessages() {
        List<SyncMessage> messages = syncMessageMapper.selectPending(100);
        
        for (SyncMessage message : messages) {
            try {
                if ("BUDGET".equals(message.getSyncType())) {
                    Contract contract = contractMapper.selectById(message.getBusinessId());
                    syncService.syncToBudget(contract);
                } else if ("PURCHASE".equals(message.getSyncType())) {
                    Contract contract = contractMapper.selectById(message.getBusinessId());
                    syncService.syncToPurchase(contract);
                }
                
                message.setStatus("SUCCESS");
            } catch (Exception e) {
                message.setRetryCount(message.getRetryCount() + 1);
                message.setErrorMessage(e.getMessage());
                
                if (message.getRetryCount() >= 3) {
                    message.setStatus("FAILED");
                }
            }
            
            syncMessageMapper.updateById(message);
        }
    }
}
```

### 4. æ¥å£å¹‚ç­‰æ€§

#### å¹‚ç­‰æ€§æ ¡éªŒ

```java
@Service
public class IdempotentSync {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean sync(String messageId, Runnable syncTask) {
        String key = "sync:message:" + messageId;
        
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(key, "1", 24, TimeUnit.HOURS);
        if (Boolean.FALSE.equals(locked)) {
            log.info("æ¶ˆæ¯å·²å¤„ç†: {}", messageId);
            return false;
        }
        
        try {
            syncTask.run();
            return true;
        } catch (Exception e) {
            redisTemplate.delete(key);
            throw e;
        }
    }
}
```

---

## ğŸ“Š æ ¸å¿ƒæˆæœ

### ç³»ç»Ÿèƒ½åŠ›

- æˆåŠŸå¯¹æ¥é¢„ç®—ç³»ç»Ÿã€é‡‡è´­ç³»ç»Ÿ
- å®ç°æ•°æ®å®æ—¶åŒæ­¥
- æ•°æ®ä¸€è‡´æ€§è¾¾åˆ°99%
- ç³»ç»ŸæˆåŠŸä¸Šçº¿å¹¶ç¨³å®šè¿è¡Œ

### è§£å†³é—®é¢˜

- å®¢æˆ·åˆåŒç®¡ç†åˆ†æ•£
- æ•°æ®å½•å…¥é‡å¤
- åˆåŒæ‰§è¡Œè·Ÿè¸ªå›°éš¾

---

## ğŸ“ é¢è¯•é‡ç‚¹

### æŠ€æœ¯äº®ç‚¹

1. **å¤šç³»ç»Ÿé›†æˆ**
   - ç»Ÿä¸€çš„å¯¹æ¥æ ‡å‡†
   - é€‚é…å™¨æ¨¡å¼

2. **æ•°æ®å®æ—¶åŒæ­¥**
   - å®šæ—¶åŒæ­¥
   - æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†

3. **æ•°æ®ä¸€è‡´æ€§**
   - æœ¬åœ°æ¶ˆæ¯è¡¨
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶

4. **æ¥å£å¹‚ç­‰æ€§**
   - Redisåˆ†å¸ƒå¼é”
   - æ¶ˆæ¯å»é‡

### å¸¸è§é¢è¯•é¢˜

1. ä½ æ˜¯å¦‚ä½•ä¸é¢„ç®—ç³»ç»Ÿã€é‡‡è´­ç³»ç»Ÿå¯¹æ¥çš„ï¼Ÿ
2. å¤šç³»ç»Ÿé›†æˆä¸­å¦‚ä½•æ•°æ®ä¸€è‡´æ€§ï¼Ÿ
3. æ•°æ®åŒæ­¥æ˜¯å¦‚ä½•ä¿è¯å¯é çš„ï¼Ÿ
4. æ¥å£å¹‚ç­‰æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
5. é€‚é…å™¨æ¨¡å¼çš„åº”ç”¨åœºæ™¯ï¼Ÿ
6. æœ¬åœ°æ¶ˆæ¯è¡¨çš„åŸç†ï¼Ÿ

---

**æ›´æ–°è¿›åº¦åˆ°å­¦ä¹ è¿›åº¦.md**